var z=Object.defineProperty;var a=(r,e)=>z(r,"name",{value:e,configurable:!0});var _=function(r,e,t,o){function n(s){return s instanceof t?s:new t(function(c){c(s)})}return a(n,"adopt"),new(t||(t=Promise))(function(s,c){function i(u){try{l(o.next(u))}catch(g){c(g)}}a(i,"fulfilled");function d(u){try{l(o.throw(u))}catch(g){c(g)}}a(d,"rejected");function l(u){u.done?s(u.value):n(u.value).then(i,d)}a(l,"step"),l((o=o.apply(r,e||[])).next())})};import{inflateSync as $}from"fflate";const O=67324752,H=33639248,S=101010256,T=8,M=0,D=2*1024*1024,y=[".astc",".pvr",".ktx",".dds"],X=[".png",".jpg",".jpeg",".webp",".bmp",...y],U={MAX_RES_CACHE_SIZE:100,MAX_RES_CACHE_MEMORY:50*1024*1024,ENABLE_CACHE_LOGGING:!0},h=new Map,p=new Map,L=new Map,A=a((r,e)=>{if(!e)return r;const t=new TextEncoder().encode(e),o=new Uint8Array(r.length);for(let n=0;n<r.length;n++){const s=t[n%t.length];o[n]=r[n]^s}return o},"decryptData"),w=a(r=>{const e=r.match(/(?:remote|assets)\/(.+)$/);return e?e[1]:r},"extractFilePath"),C=a(r=>{L.set(r,Date.now())},"updateResCacheAccessTime"),f=a((r,e)=>{h.set(r,e),C(r)},"cacheResource"),R=a((r,e)=>new Error(e instanceof Event?e.type:String(e||r)),"createLoadError"),E=a(r=>(r/(1024*1024)).toFixed(2)+"M","formatSizeToMB"),F=a((r,e="")=>{const t=new Map,o=new DataView(r),n=P(o,r.byteLength);if(n===-1)throw new Error("Invalid ZIP file: End record not found");const s=o.getUint16(n+10,!0);let i=o.getUint32(n+16,!0);for(let d=0;d<s;d++){const l=N(r,o,i,e);t.set(l.fileName,l),i=l.localHeaderOffset+46+o.getUint16(l.localHeaderOffset+28,!0)+o.getUint16(l.localHeaderOffset+30,!0)+o.getUint16(l.localHeaderOffset+32,!0)}return t},"parseZipFile"),P=a((r,e)=>{for(let t=e-22;t>=0;t--)if(r.getUint32(t,!0)===S)return t;return-1},"findEndRecord"),N=a((r,e,t,o)=>{if(e.getUint32(t,!0)!==H)throw new Error("Invalid ZIP file: Central directory signature not found");const n=e.getUint16(t+10,!0),s=e.getUint32(t+20,!0),c=e.getUint32(t+24,!0),i=e.getUint16(t+28,!0),d=e.getUint16(t+30,!0),l=e.getUint16(t+32,!0),u=e.getUint32(t+42,!0),g=e.getUint32(t+16,!0),Z=new TextDecoder().decode(new Uint8Array(r,t+46,i)),I=k(r,e,u,s,o),b=j(I,n,c);return{fileName:Z,compressedSize:s,uncompressedSize:c,compressionMethod:n,crc32:g,localHeaderOffset:t,data:b}},"parseZipEntry"),k=a((r,e,t,o,n)=>{if(e.getUint32(t,!0)!==O)throw new Error("Invalid ZIP file: Local header signature not found");const s=e.getUint16(t+26,!0),c=e.getUint16(t+28,!0),i=t+30+s+c;let d=new Uint8Array(r,i,o);return(e.getUint16(t+6,!0)&1)!==0&&n&&(d=A(d,n)),d},"readZipFileData"),j=a((r,e,t)=>{if(e===T)return $(r,{out:new Uint8Array(t)});if(e===M)return r;throw new Error(`Unsupported compression method: ${e}`)},"decompressData"),G=a((r,e)=>({name:r,dir:!1,async:a(t=>new Promise((o,n)=>{try{switch(t){case"uint8array":o(e.data);break;case"text":o(new TextDecoder().decode(e.data));break;case"base64":o(btoa(String.fromCharCode(...e.data)));break;case"blob":o(new Blob([e.data]));break;default:o(e.data)}}catch(s){n(s)}}),"async")}),"createZipFileObject");class m{static{a(this,"ZipLoader")}constructor(){this._isInit=!1,this._remoteUrl="",this._password=""}static get instance(){return this._instance||(this._instance=new m),this._instance}set remoteUrl(e){this._remoteUrl=e}get remoteUrl(){return this._remoteUrl}set password(e){this._password=e}get password(){return this._password}getZipCache(){return p}getResCache(){return h}clearResCache(e=!1){if(e){const t=h.size;h.clear(),L.clear(),console.log(`[ZipLoader] ResCache \u5DF2\u5168\u90E8\u6E05\u7406\uFF0C\u5171 ${t} \u9879`);return}if(h.size>U.MAX_RES_CACHE_SIZE){const t=Array.from(L.entries()).sort((n,s)=>n[1]-s[1]),o=Math.floor(h.size*.3);for(let n=0;n<o;n++){const[s]=t[n];h.delete(s),L.delete(s)}console.log(`[ZipLoader] ResCache \u5DF2\u6E05\u7406 ${o} \u9879\uFF0C\u5269\u4F59 ${h.size} \u9879`)}}clearZipCache(){const e=p.size;p.clear(),console.log(`[ZipLoader] ZipCache \u5DF2\u6E05\u7406\uFF0C\u5171 ${e} \u9879`)}downloadZip(e,t=!1){return new Promise((o,n)=>{const s=new XMLHttpRequest;s.responseType="arraybuffer",s.onload=()=>{s.status===200?o(s.response):n(new Error(`Download failed: ${s.status}`))},s.onerror=()=>n(new Error("Download failed")),s.open("GET",`${e}.zip${t?"?t="+Date.now():""}`,!0),s.send()})}loadZip(e,t=!1){return _(this,void 0,void 0,function*(){return new Promise((o,n)=>_(this,void 0,void 0,function*(){try{this._isInit||(this._initImageLoaders(),this._hookXMLHttpRequest(),this._isInit=!0,console.log("[ZipLoader] \u521D\u59CB\u5316\u5B8C\u6210"));const s=yield this.downloadZip(`${this._remoteUrl}/${e}`,t);this._parseZip(s),this.clearResCache(!1),o()}catch(s){console.error("[ZipLoader] Load zip failed:",s),n(s)}}))})}_parseZip(e){try{const t=F(e,this._password);for(const[o,n]of t){const s=G(o,n);p.set(o,s)}console.log(`[ZipLoader] ZIP \u89E3\u6790\u5B8C\u6210\uFF0C\u7F13\u5B58\u4E86 ${t.size} \u4E2A\u6587\u4EF6:`,Array.from(t.keys()))}catch(t){throw console.error("[ZipLoader] Parse zip failed:",t),t}}_initImageLoaders(){X.forEach(e=>{this._registerImageLoader(e)})}_registerImageLoader(e){var t;const o=y.indexOf(e)!==-1,n=a((s,c,i)=>{this._handleImageDownload(s,e,o,i)},"downloadHandler");!((t=cc.assetManager)===null||t===void 0)&&t.downloader&&cc.assetManager.downloader.register(e,n)}_handleImageDownload(e,t,o,n){if(h.has(e)){C(e),U.ENABLE_CACHE_LOGGING&&console.log(`[ZipLoader] \u547D\u4E2D ResCache: ${e}`),n(null,h.get(e));return}const s=w(e);if(p.has(s)){this._loadFromZipCache(e,s,t,o,n);return}this._downloadFromNetwork(e,o,n)}_loadFromZipCache(e,t,o,n,s){console.log(`[ZipLoader] \u4F7F\u7528 ZipCache: ${t}`);const c=p.get(t);c&&c.async("uint8array").then(i=>{n?this._handleTextureData(e,t,i,s):i.length>D?this._handleLargeImage(e,t,c,i,s):this._handleSmallImage(e,t,o,c,i,s)}).catch(i=>{console.error("[ZipLoader] Load from ZipCache failed:",i),s(i,null)})}_handleTextureData(e,t,o,n){console.log(`[ZipLoader] \u52A0\u8F7D\u7EB9\u7406: ${t}, \u5927\u5C0F: ${E(o.length)}`),f(e,o),p.delete(t),n(null,o)}_handleLargeImage(e,t,o,n,s){console.log(`[ZipLoader] \u52A0\u8F7D\u5927\u56FE\u7247(Blob): ${t}, \u5927\u5C0F: ${E(n.length)}`),o.async("blob").then(c=>{const i=URL.createObjectURL(c);this._loadImageFromUrl(i,d=>{URL.revokeObjectURL(i),f(e,d),p.delete(t),console.log(`[ZipLoader] \u56FE\u7247\u52A0\u8F7D\u6210\u529F: ${t}`),s(null,d)},d=>{URL.revokeObjectURL(i),console.error(`[ZipLoader] \u56FE\u7247\u52A0\u8F7D\u5931\u8D25: ${t}`,d),s(R("Image load failed",d),null)})})}_handleSmallImage(e,t,o,n,s,c){console.log(`[ZipLoader] \u52A0\u8F7D\u5C0F\u56FE\u7247(Base64): ${t}, \u5927\u5C0F: ${E(s.length)}`),n.async("base64").then(i=>{const d=`data:image/${o.slice(1)};base64,${i}`;this._loadImageFromUrl(d,l=>{f(e,l),p.delete(t),console.log(`[ZipLoader] \u56FE\u7247\u52A0\u8F7D\u6210\u529F: ${t}`),c(null,l)},l=>{console.error(`[ZipLoader] \u56FE\u7247\u52A0\u8F7D\u5931\u8D25: ${t}`,l),c(R("Image load failed",l),null)})})}_loadImageFromUrl(e,t,o){const n=new Image;n.crossOrigin="anonymous",n.onload=()=>t(n),n.onerror=s=>o(s),n.src=e}_downloadFromNetwork(e,t,o){if(t){const n=new XMLHttpRequest;n.responseType="arraybuffer",n.onload=()=>{n.status===200?(f(e,n.response),o(null,n.response)):o(new Error(`Download failed: ${n.status}`),null)},n.onerror=()=>o(new Error("Download failed"),null),n.open("GET",e,!0),n.send()}else this._loadImageFromUrl(e,n=>o(null,n),n=>o(R("Image download failed",n),null))}_hookXMLHttpRequest(){const e=Object.getOwnPropertyDescriptor(XMLHttpRequest.prototype,"response");e&&(this._hookXHROpen(),this._hookXHRSend(),this._hookXHRResponse(e))}_hookXHROpen(){const e=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(t,o,n,s,c){const i=w(o);return h.has(o)?(console.log(`[ZipLoader] XHR\u62E6\u622A - \u68C0\u6D4B\u5230 ResCache: ${o}`),this.zipCacheUrl=o,this.zipCachePath=i,this.isFromCache=!0):p.has(i)?(console.log(`[ZipLoader] XHR\u62E6\u622A - \u68C0\u6D4B\u5230 ZipCache: ${i}`),this.zipCacheUrl=o,this.zipCachePath=i,this.isFromCache=!1):(this.zipCacheUrl=void 0,this.zipCachePath=void 0,this.isFromCache=void 0),e.call(this,t,o,n??!0,s,c)}}_hookXHRSend(){const e=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=function(t){return _(this,void 0,void 0,function*(){if(this.zipCacheUrl&&this.zipCachePath!==void 0){yield q(this);return}return e.call(this,t)})}}_hookXHRResponse(e){Object.defineProperty(XMLHttpRequest.prototype,"response",{get:a(function(){if(this.zipCacheUrl&&h.has(this.zipCacheUrl)){const t=h.get(this.zipCacheUrl);return C(this.zipCacheUrl),console.log(`[ZipLoader] \u8FD4\u56DE\u7F13\u5B58\u54CD\u5E94: ${this.zipCachePath}, \u7C7B\u578B: ${this.responseType||"default"}`),this.responseType==="json"?JSON.parse(t):t}return e.get?e.get.call(this):void 0},"get"),set:a(function(){},"set"),configurable:!0})}}m._instance=null;function q(r){return _(this,void 0,void 0,function*(){try{r.isFromCache?(console.log(`[ZipLoader] XHR \u76F4\u63A5\u4F7F\u7528 ResCache: ${r.zipCacheUrl}`),C(r.zipCacheUrl)):h.has(r.zipCacheUrl)||(yield v(r)),B(r,200,"OK",4),x(r)}catch(e){console.error(`[ZipLoader] \u7F13\u5B58\u8D44\u6E90\u52A0\u8F7D\u5931\u8D25: ${r.zipCachePath}`,e),J(r)}})}a(q,"handleCachedRequest");function v(r){return _(this,void 0,void 0,function*(){const e=p.get(r.zipCachePath);if(!e)return;const t=r.responseType||"text";if(console.log(`[ZipLoader] XHR \u52A0\u8F7D ZipCache \u8D44\u6E90: ${r.zipCachePath}, \u7C7B\u578B: ${t}`),r.responseType==="json"){const o=yield e.async("text");f(r.zipCacheUrl,o),console.log(`[ZipLoader] JSON \u8D44\u6E90\u52A0\u8F7D\u6210\u529F: ${r.zipCachePath}`)}else{const o=yield e.async(t);f(r.zipCacheUrl,o),console.log(`[ZipLoader] \u8D44\u6E90\u52A0\u8F7D\u6210\u529F: ${r.zipCachePath}, \u7C7B\u578B: ${t}`)}p.delete(r.zipCachePath)})}a(v,"loadFromZipCacheToResCache");function B(r,e,t,o){Object.defineProperty(r,"status",{get:a(()=>e,"get"),configurable:!0}),Object.defineProperty(r,"statusText",{get:a(()=>t,"get"),configurable:!0}),Object.defineProperty(r,"readyState",{get:a(()=>o,"get"),configurable:!0})}a(B,"setXHRStatus");function x(r){if(typeof r.onload=="function"){const e=new ProgressEvent("load",{lengthComputable:!0,loaded:1,total:1});r.onload(e)}}a(x,"triggerXHRLoad");function J(r){if(r.onerror){const e=new ProgressEvent("error",{lengthComputable:!1,loaded:0,total:0});r.onerror(e)}}a(J,"triggerXHRError");export{m as ZipLoader};
